<html>
<head>

<style type="text/css" media="screen">
	body {
		background-color:lightgray;
	}
	h3 {
		font-family:arial;
	}
    #ace_editors { 
    	position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 850px;
        width: 640px;
        height: 220px;
    }

</style>

<xml id="toolbox" style="display: none">
	<category name="Conditionals">
	<block type="controls_if"></block>
	<block type="controls_if">
	  <mutation else="1"></mutation>
	</block>
	<block type="controls_if">
	  <mutation elseif="1" else="1"></mutation>
	</block>
	</category>
	<category name="Loops">
	<block type="controls_repeat_ext">
	  <value name="TIMES">
	    <block type="math_number">
	      <title name="NUM">10</title>
	    </block>
	  </value>
	</block>
	<block type="controls_whileUntil"></block>
	<block type="controls_for">
	  <title name="VAR">i</title>
	  <value name="FROM">
	    <block type="math_number">
	      <title name="NUM">1</title>
	    </block>
	  </value>
	  <value name="TO">
	    <block type="math_number">
	      <title name="NUM">10</title>
	    </block>
	  </value>
	  <value name="BY">
	    <block type="math_number">
	      <title name="NUM">1</title>
	    </block>
	  </value>
	</block>
	<block type="controls_forEach"></block>
	<block type="controls_flow_statements"></block>
	</category>

	<category name="Logic">
	  <block type="logic_compare"></block>
	  <block type="logic_operation"></block>
	  <block type="logic_negate"></block>
	  <block type="logic_boolean"></block>
	  <block type="logic_null"></block>
	  <block type="logic_ternary"></block>
	</category>
	<category name="Math">
	  <block type="math_number"></block>
	  <block type="math_arithmetic"></block>
	  <block type="math_single"></block>
	  <block type="math_trig"></block>
	  <block type="math_constant"></block>
	  <block type="math_number_property"></block>
	  <block type="math_change">
	    <value name="DELTA">
	      <block type="math_number">
	        <title name="NUM">1</title>
	      </block>
	    </value>
	  </block>
	  <block type="math_round"></block>
	  <block type="math_on_list"></block>
	  <block type="math_modulo"></block>
	  <block type="math_constrain">
	    <value name="LOW">
	      <block type="math_number">
	        <title name="NUM">1</title>
	      </block>
	    </value>
	    <value name="HIGH">
	      <block type="math_number">
	        <title name="NUM">100</title>
	      </block>
	    </value>
	  </block>
	  <block type="math_random_int">
	    <value name="FROM">
	      <block type="math_number">
	        <title name="NUM">1</title>
	      </block>
	    </value>
	    <value name="TO">
	      <block type="math_number">
	        <title name="NUM">100</title>
	      </block>
	    </value>
	  </block>
	  <block type="math_random_float"></block>
	</category>
	<category name="Lists">
	  <block type="lists_create_empty"></block>
	  <block type="lists_create_with"></block>
	  <block type="lists_repeat">
	    <value name="NUM">
	      <block type="math_number">
	        <title name="NUM">5</title>
	      </block>
	    </value>
	  </block>
	  <block type="lists_length"></block>
	  <block type="lists_isEmpty"></block>
	  <block type="lists_indexOf"></block>
	  <block type="lists_getIndex"></block>
	  <block type="lists_setIndex"></block>
	</category>
	<category name="Variables" custom="VARIABLE"></category>
	<category name="Functions" custom="PROCEDURE"></category>
</xml>


<script src="blockly_compressed.js" type="text/javascript" charset="utf-8"></script>
<script src="blocks_compressed.js" type="text/javascript" charset="utf-8"></script>
<script src="python_compressed.js" type="text/javascript"></script>
<script src="javascript_compressed.js" type="text/javascript"></script>

<script type="text/javascript" src="msg/js/en.js"></script>

<script src="pythonjs.js"></script>

<script src="bindings/blockly.py"></script>
<script src="bindings/websocket.py"></script>

<script src="libs/three/three.min.js"></script>

<!-- load the font files -->
<script src="libs/fonts/gentilis_bold.typeface.js"></script>
<script src="libs/fonts/gentilis_regular.typeface.js"></script>
<script src="libs/fonts/optimer_bold.typeface.js"></script>
<script src="libs/fonts/optimer_regular.typeface.js"></script>
<script src="libs/fonts/helvetiker_bold.typeface.js"></script>
<script src="libs/fonts/helvetiker_regular.typeface.js"></script>
<script src="libs/fonts/droid_sans_regular.typeface.js"></script>
<script src="libs/fonts/droid_sans_bold.typeface.js"></script>
<script src="libs/fonts/droid_serif_regular.typeface.js"></script>
<script src="libs/fonts/droid_serif_bold.typeface.js"></script>

<script src="bindings/three.py"></script>

<script src="libs/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="bindings/ace.py"></script>

<script type="text/python">

from websocket import *

def on_open(): print 'websocket open...'
def on_close(): print 'websocket closed'

def on_json_message( ob ):
	code = None
	with javascript:
		if typeof(ob) == 'string':
			print 'got string from server', ob
		elif 'eval' in ob:
			print 'got eval from server', ob
			code = ob['eval']
	if code:
		eval( ob['eval'] )
		JsEditor.setValue( ob['eval'] )


def compile_request(src):
	with javascript: ob = {command:'compile', code:src}
	ws.send_json_message( ob )

def connect_websocket():
	global ws
	ws = websocket(
		'ws://localhost:8080/websocket',
		on_json_message = on_json_message,
		on_open = on_open,
		on_close = on_close
	)
	print 'websocket->', ws

def compile_python():
	src = PyEditor.getValue()
	compile_request( src )

</script>

</head>

<body>



<div id="blocklyDiv" style="height: 380px; width: 830px;"></div>

<div id="THREE_container">
</div>

<div id="ace_editors">
	<div id="ace_python" style="height: 380px; width: 500px;"></div>
	<div id="ace_javascript" style="height: 180px; width: 500px;"></div>

	<p>
	<button onclick="connect_websocket()">connect to server</button>
	<button onclick="compile_python()">compile</button>
	<button onclick="test()">run test</button>
	</p>

</div>

<script type="text/python">
from blockly import *
from three import *
from ace import *

PyEditor = AceEditor( 'ace_python', mode='python', theme='monokai' )
JsEditor = AceEditor( 'ace_javascript', mode='javascript' )

Meshes = []

block = StatementBlock(block_name='x', stack_input=True, category='Transform')
@block.javascript_callback
def vector(x=0,y=0,z=0):
	print 'js-callback VECTOR', x,y,z
	with javascript:
		return [x,y,z]

with javascript:  ## called from blockly generator update
	def set_vector( vec, arr ):
		print 'js-level blockly callback', vec, arr
		vec.x = arr[0]
		vec.y = arr[1]
		vec.z = arr[2]

geoblock1 = ValueBlock('geoblock1', category='Geometry')
geoblock1.add_input_statement('position', callback=set_vector )
geoblock1.add_input_statement('rotation')  # ,callback='xxxx')
geoblock1.add_input_statement('scale')  # ,callback='xxxx')
@geoblock1.callback
def Circle( radius, segments, start, end, material=None, child=None ):
	geo = CircleGeometry( radius, segments, start, end )
	if not material: material = MeshLambertMaterial()
	mesh = Mesh( geo, material )
	Meshes.append( mesh )
	if child: mesh.add( child )
	return mesh

geoblock2 = ValueBlock('geoblock2', category='Geometry')
geoblock2.add_input_statement('position', callback=set_vector )

@geoblock2.callback
def Cube( width, height, length, material=None, child=None ):
	geo = CubeGeometry( width, height, length )
	if not material: material = MeshLambertMaterial()
	mesh = Mesh( geo, material )
	Meshes.append( mesh )
	if child: mesh.add( child )
	return mesh

geoblock3 = ValueBlock('geoblock3', category='Geometry')
@geoblock3.callback
def Cylinder( radiusTop, radiusBottom, height, material=None, child=None ):
	geo = CylinderGeometry( radiusTop, radiusBottom, height )
	if not material: material = MeshLambertMaterial()
	mesh = Mesh( geo, material )
	Meshes.append( mesh )
	if child: mesh.add( child )
	return mesh

geoblock4 = ValueBlock('geoblock4', category='Geometry')
@geoblock4.callback
def Text3D( text, size, material=None, child=None ):
	geo = TextGeometry( text, size )
	if not material: material = MeshLambertMaterial()
	mesh = Mesh( geo, material )
	Meshes.append( mesh )
	if child: mesh.add( child )
	return mesh

geoblock5 = ValueBlock('geoblock5', category='Geometry')
@geoblock5.callback
def Icosahedron( radius, detail, material=None, child=None ):
	geo = IcosahedronGeometry( radius, detail )
	if not material: material = MeshLambertMaterial()
	mesh = Mesh( geo, material )
	Meshes.append( mesh )
	if child: mesh.add( child )
	return mesh


tblock1 = ValueBlock('tblock1', category='Transform')
@tblock1.callback
def position(object, x,y,z):
	object.position.set(x,y,z)
	return object

tblock2 = ValueBlock('tblock2', category='Transform')
@tblock2.callback
def rotation(object, x,y,z):
	object.rotation.set(x,y,z)
	return object

tblock3 = ValueBlock('tblock3', category='Transform')
@tblock3.callback
def scale(object, x,y,z):
	object.scale.set(x,y,z)
	return object




sblock1 = StatementBlock('sblock1', stack_output=True, category='Scene')
@sblock1.callback
def initialize():
	global ren, scn, cam

	div = document.getElementById( 'THREE_container' )
	if div.firstChild:
		div.removeChild( div.firstChild )

	width = 830; height = 280
	scn = Scene()
	cam = PerspectiveCamera( 45, width/height, 0.01, 10000)
	cam.position.z = 100
	cam.position.x = 5

	ren = WebGLRenderer()
	ren.setSize( width, height )
	ren.setClearColor( red=0.7, green=0.7, blue=0.7 )

	div.appendChild( ren.domElement )

	light = PointLight()
	light.position.set( 0, 100, 90 )
	scn.add( light )


sblock2 = StatementBlock('sblock2', stack_input=True, stack_output=True, category='Scene')
@sblock2.callback
def add_to_scene( object ):
	scn.add( object )

sblock3 = StatementBlock('sblock3', stack_input=True, category='Scene')
@sblock3.callback
def animate():
	requestAnimationFrame( animate )

	for m in Meshes:
		m.rotation.x = m.rotation.x + 0.02
		m.rotation.y = m.rotation.y + 0.01

		x = m.quaternion.x
		y = m.quaternion.y
		z = m.quaternion.z
		m.material.color.setRGB( x,y,z )

	ren.render( scn, cam )



def blockly_update_callback():
	with javascript: code = Blockly.Python.workspaceToCode()
	PyEditor.setValue( code )


initialize_blockly( on_changed_callback=blockly_update_callback )

</script>

</body>
</html>